---
import { getEntry, render } from 'astro:content'

import Prose from '@/components/Prose.astro'
import { getLocale, localizeHref } from '@/i18n/runtime'
import Layout from '@/layouts/Layout.astro'

const currentLocale = getLocale()
const slug = Astro.params.slug!

const post = await getEntry('posts', slug)

if (post === undefined || post.data.locale !== currentLocale)
  return Astro.rewrite('/404')

const metadata = {
  title: post.data.title,
  description: post.data.description,
  alternates: post.data.alternates.map(({ locale, slug }) => ({
    locale,
    href: localizeHref(`posts/${slug}`, { locale }),
  })),
}

const { Content, headings } = await render(post)
---

<Layout metadata={metadata}>
  <Prose
    id='main-content'
    as='main'
    toc={headings}>
    <Content />
  </Prose>
</Layout>
