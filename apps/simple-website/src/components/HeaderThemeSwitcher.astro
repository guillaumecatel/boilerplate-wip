---
// Pas de code côté serveur nécessaire
---

<fieldset id='theme-switcher'>
  <legend>Theme</legend>

  <input
    type='radio'
    name='theme'
    value='light'
    id='theme-light'
  />
  <label for='theme-light'>Light</label>

  <input
    type='radio'
    name='theme'
    value='dark'
    id='theme-dark'
  />
  <label for='theme-dark'>Dark</label>

  <input
    type='radio'
    name='theme'
    value='system'
    id='theme-system'
  />
  <label for='theme-system'>System</label>
</fieldset>

<script>
  type ThemePreference = 'light' | 'dark' | 'system'
  type ResolvedTheme = 'light' | 'dark'

  // Fonction pour obtenir le thème préféré de l'utilisateur
  function getThemePreference(): ThemePreference {
    const stored = localStorage.getItem('theme-preference')
    if (stored === 'light' || stored === 'dark' || stored === 'system') {
      return stored
    }
    return 'system'
  }

  // Fonction pour résoudre le thème effectif (light ou dark)
  function resolveTheme(preference: ThemePreference): ResolvedTheme {
    if (preference === 'system') {
      return window.matchMedia('(prefers-color-scheme: dark)').matches
        ? 'dark'
        : 'light'
    }
    return preference
  }

  // Fonction pour appliquer le thème au DOM
  function applyTheme(theme: ResolvedTheme) {
    const html = document.documentElement

    // Appliquer la classe
    if (theme === 'dark') {
      html.classList.add('dark')
      html.classList.remove('light')
    } else {
      html.classList.add('light')
      html.classList.remove('dark')
    }

    // Appliquer l'attribut data-theme
    html.setAttribute('data-theme', theme)
  }

  // Fonction pour mettre à jour les radios
  function updateRadios(preference: ThemePreference) {
    const lightRadio = document.getElementById(
      'theme-light',
    ) as HTMLInputElement
    const darkRadio = document.getElementById('theme-dark') as HTMLInputElement
    const systemRadio = document.getElementById(
      'theme-system',
    ) as HTMLInputElement

    if (lightRadio) lightRadio.checked = preference === 'light'
    if (darkRadio) darkRadio.checked = preference === 'dark'
    if (systemRadio) systemRadio.checked = preference === 'system'
  }

  // Fonction pour initialiser le thème
  function initTheme() {
    const preference = getThemePreference()
    const resolved = resolveTheme(preference)
    applyTheme(resolved)
    updateRadios(preference)
  }

  // Fonction pour gérer le changement de thème
  function handleThemeChange(preference: ThemePreference) {
    localStorage.setItem('theme-preference', preference)
    const resolved = resolveTheme(preference)
    applyTheme(resolved)
  }

  // Initialiser au chargement
  initTheme()

  // Ajouter les écouteurs sur les radios
  const lightRadio = document.getElementById('theme-light')
  const darkRadio = document.getElementById('theme-dark')
  const systemRadio = document.getElementById('theme-system')

  lightRadio?.addEventListener('change', () => handleThemeChange('light'))
  darkRadio?.addEventListener('change', () => handleThemeChange('dark'))
  systemRadio?.addEventListener('change', () => handleThemeChange('system'))

  // Écouter les changements de prefers-color-scheme (uniquement si system est sélectionné)
  window
    .matchMedia('(prefers-color-scheme: dark)')
    .addEventListener('change', (e) => {
      const preference = getThemePreference()
      if (preference === 'system') {
        const resolved = e.matches ? 'dark' : 'light'
        applyTheme(resolved)
      }
    })

  // Réappliquer le thème après navigation (pour les SPA)
  document.addEventListener('astro:after-swap', () => {
    initTheme()

    // Réattacher les écouteurs
    const newLightRadio = document.getElementById('theme-light')
    const newDarkRadio = document.getElementById('theme-dark')
    const newSystemRadio = document.getElementById('theme-system')

    newLightRadio?.addEventListener('change', () => handleThemeChange('light'))
    newDarkRadio?.addEventListener('change', () => handleThemeChange('dark'))
    newSystemRadio?.addEventListener('change', () =>
      handleThemeChange('system'),
    )
  })
</script>
